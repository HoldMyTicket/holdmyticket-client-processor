!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("axios")):"function"==typeof define&&define.amd?define(["axios"],t):"object"==typeof exports?exports.hmt_client_processor=t(require("axios")):e.hmt_client_processor=t(e.axios)}(window,function(e){return function(e){var t={};function r(n){if(t[n])return t[n].exports;var o=t[n]={i:n,l:!1,exports:{}};return e[n].call(o.exports,o,o.exports,r),o.l=!0,o.exports}return r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)r.d(n,o,function(t){return e[t]}.bind(null,o));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=1)}([function(t,r){t.exports=e},function(e,t,r){"use strict";r.r(t);var n=r(0),o=r.n(n),a={api_url:"",env:"",app_type:"",current_processor:"",isHmtMobile:!1,url_prefix:function(e){return this.api_url+e},spreedly_url:function(e){return"https://core.spreedly.com/v1/payment_methods.json?environment_key="+e},fullsteam_url:function(){return"https://api"+("local"==this.env||"dev"==this.env||"staging"==this.env?"-ext":"")+".fullsteampay.net/"},submit_transaction:function(e,t,r){this._remove_card_data(),"spreedly"==t.processor_method?this._submit_spreedly(e,t,r):"fullsteam"==t.processor_method?this._submit_fullsteam(e,t,r):this._throw_error(!0,{status:"error",msg:"No processing method setup"},r)},_submit_spreedly:function(e,t,r){var n=this;n.current_processor="spreedly",t.payment_token?n._submit_spreedly_transaction(t,function(e,t){a._respond(e,t,r)}):n._get_spreedly_token(e,t.spreedly_environment_key,function(e,o){e?a._throw_error(e,o,r):(t.payment_token=o.transaction.payment_method.token,n._submit_spreedly_transaction(t,function(e,t){!e&&t.ticket_key&&n._save_card_to_webuser({ticket_key:t.ticket_key}),a._respond(e,t,r)}))}),t.cc_retain&&"y"==t.cc_retain&&n.save_card(e,t,"fullsteam")},_get_spreedly_token:function(e,t,r){this._request({url:this.spreedly_url(t),type:"POST",withCredentials:!1,data:e,cb:function(e,t){a._respond(e,t,r)}})},_submit_spreedly_transaction:function(e,t){this._request({url:this.url_prefix("shop/carts/submit"),type:"POST",data:e,form_encoded:!0,withCredentials:!0,cb:function(r,n){e.ticket_index&&(n.ticket_index=e.ticket_index),a._respond(r,n,t)}})},_submit_fullsteam:function(e,t,r){var n=this;n.current_processor="fullsteam",t.payment_token?n._submit_fullsteam_transaction(t,function(e,t){a._respond(e,t,r)}):n._get_fullsteam_auth_key(function(o,s){var _=null;s&&s.status&&"ok"==s.status&&s.authenticationKey&&(_=s.authenticationKey),n._get_fullsteam_token(e,t,_,function(e,o){if(!o||!o.isSuccessful||!o.token)return a._handle_fullsteam_error(o,r);t.payment_token=o.token,n._submit_fullsteam_transaction(t,function(e,o){t.ticket_index&&(o.ticket_index=t.ticket_index),console.log("submit_fullsteam res",e,o),!e&&o.ticket_key&&n._save_card_to_webuser({ticket_key:o.ticket_key}),a._respond(e,o,r)})})}),t.cc_retain&&"y"==t.cc_retain&&(t.spreedly_environment_key||(t.spreedly_environment_key=n._get_spreedly_env_key()),n.save_card(e,t,"spreedly"))},_get_spreedly_env_key:function(){return this.spreedly_environment_key?this.spreedly_environment_key:config&&config.spreedly_environment_key?config.spreedly_environment_key:""},save_card:function(e,t,r,n){var o=this;if(console.log("SAVE CARD",e,t,n),e&&e.payment_method&&e.payment_method.credit_card){var a={card:e.payment_method.credit_card,processor:r};(n=n||"")&&(a.ticket_key=n),"spreedly"==r&&o._get_spreedly_token(e,t.spreedly_environment_key,function(e,t){console.log("spreedly token result",e,t),e||(t.transaction&&t.transaction.payment_method&&t.transaction.payment_method.token&&(a.token=t.transaction.payment_method.token),o._save_card_to_webuser(a))}),"fullsteam"==r&&o._get_fullsteam_auth_key(function(r,n){var s=null;n&&n.status&&"ok"==n.status&&n.authenticationKey&&(s=n.authenticationKey),s&&o._get_fullsteam_token(e,t,s,function(e,t){t&&t.isSuccessful&&t.token&&(a.token=t.token,o._save_card_to_webuser(a))})})}},webuser_save_card:function(e,t,r,n){var o=this;o._get_spreedly_token(e,t.spreedly_environment_key,function(s,_){if(console.log("spreedly token result",s,_),s)a._respond(s,_,n);else{var i={webuser_id:r,token:_.transaction.payment_method.token,vault:"spreedly"};o._request({url:o.url_prefix("public/users/save_credit_card"),type:"POST",withCredentials:!1,data:i,form_encoded:!0,cb:function(s,_){if(_&&"200"==_.status&&"OK"==_.statusText&&(_=_.data),!_||!_.status||"ok"!=_.status)return a._respond(s,_,n);o._get_fullsteam_auth_key(function(s,_){var i=null;_&&_.status&&"ok"==_.status&&_.authenticationKey&&(i=_.authenticationKey),i&&(!t.zip&&e.payment_method.credit_card.zip&&(t.zip=e.payment_method.credit_card.zip),o._get_fullsteam_token(e,t,i,function(t,s){if(!s||!s.isSuccessful||!s.token)return a._respond(t,s,n);var _=e.payment_method.credit_card?o._format_card_for_save(e.payment_method.credit_card):null,i={webuser_id:r,vault:"fullsteam",token:s.token,card_data:_};o._request({url:o.url_prefix("public/users/save_additional_card"),type:"POST",withCredentials:!1,data:i,form_encoded:!0,cb:function(e,t){console.log("err,res",e,t),a._respond(e,t,n)}})}))})}})}})},_save_card_to_webuser:function(e){var t=this;console.log("ARGS",e),t._remember_card_data(e);var r=t.card_data?t._format_card_for_save(t.card_data):null;if(t.card_ticket_key&&r&&t.card_token&&t.card_processor){console.log("card_data checks PASSED",r);var n={ticket_key:t.card_ticket_key,vault:t.card_processor,token:t.card_token,card_data:r};this._request({url:t.url_prefix("public/orders/save_additional_card"),type:"POST",withCredentials:!1,data:n,form_encoded:!0,cb:function(e,t){console.log("err,res",e,t)}})}},_format_card_for_save:function(e){return console.log("card_data",e),!!e.full_name&&(!!e.month&&(!!e.year&&(!!e.number&&{full_name:e.full_name,last_four:this._get_last_four(e.number),exp_month:e.month,exp_year:e.year})))},_get_last_four:function(e){return e.substr(e.length-4)},_remember_card_data:function(e){e.card&&(this.card_data=e.card),e.token&&(this.card_token=e.token),e.processor&&(this.card_processor=e.processor),e.ticket_key&&(this.card_ticket_key=e.ticket_key)},_remove_card_data:function(){delete this.card_data,delete this.card_token,delete this.processor,delete this.card_ticket_key},_get_fullsteam_auth_key:function(e){this._request({url:this.url_prefix("shop/processors/get_authentication_key"),cb:function(t,r){a._respond(t,r,e)}})},_get_fullsteam_token:function(e,t,r,n){if(console.log("TRANSACTION",t),e&&e.payment_method&&e.payment_method.credit_card&&e.payment_method.credit_card.number&&e.payment_method.credit_card.month&&e.payment_method.credit_card.year&&e.payment_method.credit_card.full_name&&e.payment_method.credit_card.verification_value){var o={clearTextCardData:{cardNumber:e.payment_method.credit_card.number.replace(/\s/g,""),cvv:e.payment_method.credit_card.verification_value,expirationMonth:e.payment_method.credit_card.month,expirationYear:e.payment_method.credit_card.year,billingInformation:{nameOnAccount:e.payment_method.credit_card.full_name,firstName:t.f_name||null,lastName:t.l_name||null,address1:t.address1||null,address2:t.address2||null,city:t.city||null,state:t.state||null,zip:t.zip||null,phone:t.phone||null,email:t.email||null}},cardEntryContext:"box"==this.app_type?1:5,performAccountVerification:!0};this._request({url:this.fullsteam_url()+"api/token/card/clearText/create",type:"POST",cors:!0,crossdomain:!0,data:o,json:!0,withCredentials:!1,auth_key:r,cb:function(e,t){a._respond(e,t,n)}})}else n(!0,"Missing required card inputs")},_submit_fullsteam_transaction:function(e,t){this._request({url:this.url_prefix("shop/carts/submit"),type:"POST",data:e,form_encoded:!0,withCredentials:!0,cb:function(e,r){a._respond(e,r,t)}})},_request:function(e){var t=this,r={};e.json&&(r["content-type"]="application/json;charset=UTF-8"),e.form_encoded&&(r["content-type"]="application/x-www-form-urlencoded;charset=UTF-8",e.data=a._serialize(e.data)),e.auth_key&&(r.authenticationKey=e.auth_key),o()({method:e.type||"GET",url:e.url,mode:"no-cors",credentials:"same-origin",headers:r,withCredentials:e.withCredentials||!1,crossdomain:e.crossdomain||!1,data:e.data}).then(function(r){t.isHmtMobile&&200==r.status&&!r.statusText&&(r.statusText="OK"),e.cb&&e.cb(null,r)}).catch(function(t,r){var n=a._format_error(t);r||(r={}),r.msg=n,e.cb&&e.cb(t,r)})},_format_error:function(e){return"spreedly"==this.current_processor?this._format_spreedly_error(e):this._format_fullsteam_error(e)},_format_spreedly_error:function(e){if(e.response&&e.response.data&&e.response.data.errors){for(var t="Processing Error:<br>",r=0;r<e.response.data.errors.length;r++){var n=e.response.data.errors[r];t+=n.message?"- "+n.message+"<br>":""}return t}return"Unkown error"},_format_fullsteam_error:function(e){return e&&e.msg?e.msg:"Unkown error"},_handle_fullsteam_error:function(e,t){var r="";if(e&&e.responseDetails)for(key in e.responseDetails)r+=e.responseDetails[key].message+"\n\n";return a._throw_error(!0,{msg:r},t)},_respond:function(e,t,r){!e&&t&&t.data&&"error"!=t.status?r&&r(null,t.data):a._throw_error(e,t,r)},_throw_error:function(e,t,r){!e&&t.msg&&(e=t.msg),e||(e=!0),r&&r(e,t)},_serialize:function(e){var t,r=[];for(t in e)if(e.hasOwnProperty(t)){var n=t,o=e[t];r.push(null!==o&&"object"==typeof o?a._serialize(o,n):encodeURIComponent(n)+"="+encodeURIComponent(o))}return r.join("&")}};t.default=a}]).default});