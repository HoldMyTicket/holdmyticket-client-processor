var hmt_client_processor={api_url:"",app_type:"",current_processor:"",url_prefix:function(e){return this.api_url+e},spreedly_url:function(e){return"https://core.spreedly.com/v1/payment_methods.json?environment_key="+e},fullsteam_url:function(){return"https://api-ext.fullsteampay.net/"},submit_transaction:function(e,t,r){this._remove_card_data(),"spreedly"==t.processor_method?this._submit_spreedly(e,t,r):"fullsteam"==t.processor_method?this._submit_fullsteam(e,t,r):this._throw_error(!0,{status:"error",msg:"No processing method setup"},r)},_submit_spreedly:function(e,r,n){var o=this;o.current_processor="spreedly",o._get_spreedly_token(e,r.spreedly_environment_key,function(e,t){e?hmt_client_processor._throw_error(e,t,n):(r.payment_token=t.transaction.payment_method.token,o._submit_spreedly_transaction(r,function(e,t){!e&&t.ticket_key&&o._save_card_to_webuser({ticket_key:t.ticket_key}),hmt_client_processor._respond(e,t,n)}))}),r.cc_retain&&"y"==r.cc_retain&&o.save_card(e,r,"fullsteam")},_get_spreedly_token:function(e,t,r){this._request({url:this.spreedly_url(t),type:"POST",withCredentials:!1,data:e,cb:function(e,t){hmt_client_processor._respond(e,t,r)}})},_submit_spreedly_transaction:function(e,r){this._request({url:this.url_prefix("shop/carts/submit"),type:"POST",data:e,form_encoded:!0,withCredentials:!0,cb:function(e,t){hmt_client_processor._respond(e,t,r)}})},_submit_fullsteam:function(n,o,s){var a=this;a.current_processor="fullsteam",a._get_fullsteam_auth_key(function(e,t){var r=null;t&&t.status&&"ok"==t.status&&t.authenticationKey&&(r=t.authenticationKey),a._get_fullsteam_token(n,o,r,function(e,t){if(!t||!t.isSuccessful||!t.token)return hmt_client_processor._handle_fullsteam_error(t,s);o.payment_token=t.token,a._submit_fullsteam_transaction(o,function(e,t){console.log("submit_fullsteam res",e,t),!e&&t.ticket_key&&a._save_card_to_webuser({ticket_key:t.ticket_key}),hmt_client_processor._respond(e,t,s)})})}),o.cc_retain&&"y"==o.cc_retain&&(o.spreedly_environment_key||(o.spreedly_environment_key=a._get_spreedly_env_key()),a.save_card(n,o,"spreedly"))},_get_spreedly_env_key:function(){return this.spreedly_environment_key?this.spreedly_environment_key:config&&config.spreedly_environment_key?config.spreedly_environment_key:""},save_card:function(n,o,e,t){var s=this;if(console.log("SAVE CARD",n,o,t),n&&n.payment_method&&n.payment_method.credit_card){var a={card:n.payment_method.credit_card,processor:e};(t=t||"")&&(a.ticket_key=t),"spreedly"==e&&s._get_spreedly_token(n,o.spreedly_environment_key,function(e,t){console.log("spreedly token result",e,t),e||(t.transaction&&t.transaction.payment_method&&t.transaction.payment_method.token&&(a.token=t.transaction.payment_method.token),s._save_card_to_webuser(a))}),"fullsteam"==e&&s._get_fullsteam_auth_key(function(e,t){var r=null;t&&t.status&&"ok"==t.status&&t.authenticationKey&&(r=t.authenticationKey),r&&s._get_fullsteam_token(n,o,r,function(e,t){t&&t.isSuccessful&&t.token&&(a.token=t.token,s._save_card_to_webuser(a))})})}},_save_card_to_webuser:function(e){var t=this;console.log("ARGS",e),t._remember_card_data(e);var r=t.card_data?t._format_card_for_save(t.card_data):null;if(t.card_ticket_key&&r&&t.card_token&&t.card_processor){console.log("card_data checks PASSED",r);var n={ticket_key:t.card_ticket_key,vault:t.card_processor,token:t.card_token,card_data:r};this._request({url:t.url_prefix("public/orders/save_additional_card"),type:"POST",withCredentials:!1,data:n,form_encoded:!0,cb:function(e,t){console.log("err,res",e,t)}})}},_format_card_for_save:function(e){return console.log("card_data",e),!!e.full_name&&(!!e.month&&(!!e.year&&(!!e.number&&{full_name:e.full_name,last_four:this._get_last_four(e.number),exp_month:e.month,exp_year:e.year})))},_get_last_four:function(e){return e.substr(e.length-4)},_remember_card_data:function(e){e.card&&(this.card_data=e.card),e.token&&(this.card_token=e.token),e.processor&&(this.card_processor=e.processor),e.ticket_key&&(this.card_ticket_key=e.ticket_key)},_remove_card_data:function(){delete this.card_data,delete this.card_token,delete this.processor,delete this.card_ticket_key},_get_fullsteam_auth_key:function(r){this._request({url:this.url_prefix("shop/processors/get_authentication_key"),cb:function(e,t){hmt_client_processor._respond(e,t,r)}})},_get_fullsteam_token:function(e,t,r,n){if(console.log("TRANSACTION",t),e&&e.payment_method&&e.payment_method.credit_card&&e.payment_method.credit_card.number&&e.payment_method.credit_card.month&&e.payment_method.credit_card.year&&e.payment_method.credit_card.full_name&&e.payment_method.credit_card.verification_value){var o={clearTextCardData:{cardNumber:e.payment_method.credit_card.number.replace(/\s/g,""),cvv:e.payment_method.credit_card.verification_value,expirationMonth:e.payment_method.credit_card.month,expirationYear:e.payment_method.credit_card.year,billingInformation:{nameOnAccount:e.payment_method.credit_card.full_name,firstName:t.f_name||null,lastName:t.l_name||null,address1:t.address1||null,address2:t.address2||null,city:t.state||null,state:t.state||null,zip:t.zip||null,phone:t.phone||null,email:t.email||null}},cardEntryContext:"box"==this.app_type?1:5,performAccountVerification:!0};this._request({url:this.fullsteam_url()+"api/token/card/clearText/create",type:"POST",cors:!0,crossdomain:!0,data:o,json:!0,withCredentials:!1,auth_key:r,cb:function(e,t){hmt_client_processor._respond(e,t,n)}})}else n(!0,"Missing required card inputs")},_submit_fullsteam_transaction:function(e,r){this._request({url:this.url_prefix("shop/carts/submit"),type:"POST",data:e,form_encoded:!0,withCredentials:!0,cb:function(e,t){hmt_client_processor._respond(e,t,r)}})},_request:function(n){var e={};n.json&&(e["content-type"]="application/json;charset=UTF-8"),n.form_encoded&&(e["content-type"]="application/x-www-form-urlencoded;charset=UTF-8",n.data=hmt_client_processor._serialize(n.data)),n.auth_key&&(e.authenticationKey=n.auth_key),axios({method:n.type||"GET",url:n.url,mode:"no-cors",credentials:"same-origin",headers:e,withCredentials:n.withCredentials||!1,crossdomain:n.crossdomain||!1,data:n.data}).then(function(e){n.cb&&n.cb(null,e)}).catch(function(e,t){var r=hmt_client_processor._format_error(e);t||(t={}),t.msg=r,n.cb&&n.cb(e,t)})},_format_error:function(e){return"spreedly"==this.current_processor?this._format_spreedly_error(e):this._format_fullsteam_error(e)},_format_spreedly_error:function(e){if(e.response&&e.response.data&&e.response.data.errors){for(var t="Processing Error:<br>",r=0;r<e.response.data.errors.length;r++){var n=e.response.data.errors[r];t+=n.message?"- "+n.message+"<br>":""}return t}return"Unkown error"},_format_fullsteam_error:function(e){return e&&e.msg?e.msg:"Unkown error"},_handle_fullsteam_error:function(e,t){var r="";if(e&&e.responseDetails)for(key in e.responseDetails)r+=e.responseDetails[key].message+"\n\n";return hmt_client_processor._throw_error(!0,{msg:r},t)},_respond:function(e,t,r){!e&&t&&t.data&&"error"!=t.status?r&&r(null,t.data):hmt_client_processor._throw_error(e,t,r)},_throw_error:function(e,t,r){!e&&t.msg&&(e=t.msg),e||(e=!0),r&&r(e,t)},_serialize:function(e){var t,r=[];for(t in e)if(e.hasOwnProperty(t)){var n=t,o=e[t];r.push(null!==o&&"object"==typeof o?hmt_client_processor._serialize(o,n):encodeURIComponent(n)+"="+encodeURIComponent(o))}return r.join("&")}};